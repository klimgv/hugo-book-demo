# Optiimisc Lock

![](/hugo-book-demo/img/martin_fowler-optiimisc-lock.png)

## Назначение паттерна
Применяется для сохранения консистентности данных при конкуретном редактировании.
Не накладывает блокировку на ресурс при чтении, но проверяет целостность при обновлении ресурса (update).

## Принцип действия
Одна из наиболее широко распространенных реализаций оптимистичной блокировки - это добавление версии к ресурсу. Например, добавление колонки `version` к таблице. Каждый раз когда происходит изменение записи, то увеличивается значение в поле `version`.  В SQL запросе это может выглядеть так `UPDATE  item SET stock = stock - 2, version = version + 1 WHERE id = 1 AND version = 1`. 

Также можно использовать колонку с датой, например `updated_at` (чем ни выше точность даты, тем меньше вероятность проблем, лучше использовать нано-секунды). В SQL запросе это может выглядеть так `UPDATE  item SET stock = stock - 2, updated_at = nowNs() WHERE id = 1 AND updated_at = ?`.

Транзакция будет успешно выполнена, если с момента чтения записи до обновления записи никто другой не вносил обновлений в эту запись.

![](/hugo-book-demo/img/optiimistic-lock.png)

При конкурентном обновлении записи выполнится только первое обновление, остальные обновления не найдут запись, так как версия уже обовится к этому времени.
Такие транзакции следут откатывать, либо реализовать стратегию, которая будет реализовывать механику обработки конфликта, например, повторное чтение и повтор транзакции с новой версией записи.

{{< hint info >}}
Может быть реализована иная стратегия проверки документа, основанная не на версии документа. Например, могут проверяться все (или часть) полей документа.
{{< /hint >}}

## Альтернативы
Если вам не подходит optimistic lock, то нужно посмотреть в pessimistic lock. Pessimistic lock устанавливает блокировку на уровне `SELECT`, не позволяя считывать запись пока есть lock.


## Дополнительные материалы
+ [Optimistic Lock в ElasticSearch](https://www.elastic.co/guide/en/elasticsearch/guide/master/optimistic-concurrency-control.html)
+ [Optimistic Lock для GORM](https://github.com/go-gorm/optimisticlock)
+ [Version Key Revision в Mongoose ODM](https://mongoosejs.com/docs/guide.html#versionKey)